<app-header></app-header>

<section class="store-page">
  <header class="hero">
    <div>
      <h1>Discover new worlds</h1>
      <p>Browse curated games across every genre and complete your collection.</p>
    </div>
    <button type="button" (click)="clearFilters()">Reset filters</button>
  </header>

  <section class="filters">
    <input
      type="search"
      placeholder="Search games by name"
      [ngModel]="searchTerm()"
      (ngModelChange)="searchTerm.set($event)"
    />

    <div class="categories" *ngIf="categories$ | async as categories">
      <button
        type="button"
        [class.active]="selectedCategory() === 'all'"
        (click)="selectCategory('all')"
      >
        All
      </button>
      <button
        type="button"
        *ngFor="let category of categories"
        [class.active]="selectedCategory() === category"
        (click)="selectCategory(category)"
      >
        {{ category }}
      </button>
    </div>
  </section>

  <section class="content">
    <div class="games">
      <h2>Store catalog</h2>
      <p class="message" *ngIf="message()">{{ message() }}</p>
      <p class="error" *ngIf="errorMessage()">{{ errorMessage() }}</p>

      <div class="game-grid" *ngIf="games$ | async as games">
        <article class="game-card" *ngFor="let game of games">
          <div class="cover" [style.background-image]="'url(' + (game.coverImage || 'https://picsum.photos/seed/' + game.id + '/600/400') + ')'">
            <span class="category">{{ game.category }}</span>
            <span class="badge" *ngIf="game.isOwned">Owned</span>
          </div>
          <div class="details">
            <h3>{{ game.title }}</h3>
            <p>{{ game.description }}</p>
            <div class="meta">
              <span>{{ game.price | number:'1.2-2' }} ฿</span>
              <small>Released {{ game.releaseDate | date:'mediumDate' }}</small>
            </div>
            <button type="button" [disabled]="game.isOwned" (click)="addToCart(game)">
              {{ game.isOwned ? 'Owned' : 'Add to cart' }}
            </button>
          </div>
        </article>
      </div>
    </div>

    <aside class="sidebar">
      <section class="best-sellers" *ngIf="bestSellers$ | async as bestSellers">
        <h2>Top sellers</h2>
        <ol>
          <li *ngFor="let game of bestSellers; let i = index">
            <span class="rank">#{{ i + 1 }}</span>
            <div>
              <h3>{{ game.title }}</h3>
              <p>{{ game.totalSales }} sales • {{ game.price | number:'1.0-0' }} ฿</p>
            </div>
          </li>
        </ol>
      </section>

      <section class="cart" *ngIf="cartState$ | async as cart">
        <h2>Your cart</h2>
        <p *ngIf="!cart.items.length" class="empty">No games added yet.</p>

        <ul *ngIf="cart.items.length">
          <li *ngFor="let item of cart.items">
            <div>
              <strong>{{ item.game.title }}</strong>
              <small>{{ item.game.price | number:'1.2-2' }} ฿</small>
            </div>
            <button type="button" (click)="removeFromCart(item.game.id)">Remove</button>
          </li>
        </ul>

        <div class="discount">
          <input
            type="text"
            placeholder="Discount code"
            [value]="discountInput()"
            (input)="discountInput.set($any($event.target).value)"
          />
          <div class="actions">
            <button type="button" (click)="applyDiscount()">Apply</button>
            <button type="button" (click)="clearDiscount()" [disabled]="!cart.discountCode">Clear</button>
          </div>
          <p class="info" *ngIf="cart.discountCode">Using {{ cart.discountCode }}</p>
        </div>

        <dl class="summary">
          <div>
            <dt>Subtotal</dt>
            <dd>{{ cart.summary.totalBeforeDiscount | number:'1.2-2' }} ฿</dd>
          </div>
          <div>
            <dt>Discount</dt>
            <dd>-{{ cart.summary.discountAmount | number:'1.2-2' }} ฿</dd>
          </div>
          <div class="total">
            <dt>Total</dt>
            <dd>{{ cart.summary.totalAfterDiscount | number:'1.2-2' }} ฿</dd>
          </div>
        </dl>

        <button type="button" class="checkout" (click)="checkout(cart)" [disabled]="!cart.items.length">
          Checkout
        </button>
      </section>
    </aside>
  </section>
</section>
